<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <?ifndef ProductVersion ?>
    <?define ProductVersion = "0.1.0" ?>
  <?endif?>

  <?ifndef UpgradeCode ?>
    <?define UpgradeCode = "B8A2AE7B-41E3-4E64-9A5F-41E1D1D6C6F8" ?>
  <?endif?>

  <?ifndef HasLlvmBackend ?>
    <?define HasLlvmBackend = "0" ?>
  <?endif?>

  <?ifndef LlvmDir ?>
    <?define LlvmDir = "" ?>
  <?endif?>

  <?ifndef DistDir ?>
    <?error DistDir no fue definido. Pasa -d DistDir="...\dist" desde build_msi.ps1 ?>
  <?endif?>

  <Package
      Name="AymaraLang"
      Manufacturer="AymaraLang Project"
      Version="$(var.ProductVersion)"
      UpgradeCode="$(var.UpgradeCode)"
      Language="1033"
      InstallerVersion="500"
      Compressed="yes"
      Scope="perMachine">

    <MajorUpgrade DowngradeErrorMessage="Ya existe una versión más reciente de AymaraLang." />
    <MediaTemplate EmbedCab="yes" />

    <Icon Id="AppIcon" SourceFile="$(sys.SOURCEFILEDIR)..\..\assets\logo.ico" />
    <Property Id="ARPPRODUCTICON" Value="AppIcon" />

    <ui:WixUI Id="WixUI_FeatureTree" InstallDirectory="INSTALLDIR" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <!-- PREREQS: AppSearch + Launch (WiX v4) -->

    <!-- NASM: App Paths (Registro). Para valor default: sin atributo Name -->
    <Property Id="NASM_APP_PATH">
      <RegistrySearch Id="NasmAppPaths64"
                      Root="HKLM"
                      Key="SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\nasm.exe"
                      Type="raw" />
    </Property>

    <Property Id="NASM_APP_PATH_WOW">
      <RegistrySearch Id="NasmAppPathsWow"
                      Root="HKLM"
                      Key="SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\App Paths\nasm.exe"
                      Type="raw" />
    </Property>

    <!-- NASM: rutas típicas -->
    <Property Id="NASM_IN_PROGFILES64">
      <DirectorySearch Id="NasmPf64Dir" Path="[ProgramFiles64Folder]NASM">
        <FileSearch Id="NasmPf64Exe" Name="nasm.exe" />
      </DirectorySearch>
    </Property>

    <Property Id="NASM_IN_PROGFILES32">
      <DirectorySearch Id="NasmPf32Dir" Path="[ProgramFilesFolder]NASM">
        <FileSearch Id="NasmPf32Exe" Name="nasm.exe" />
      </DirectorySearch>
    </Property>

    <!-- GCC: App Paths (Registro). Para valor default: sin atributo Name -->
    <Property Id="GCC_APP_PATH">
      <RegistrySearch Id="GccAppPaths64"
                      Root="HKLM"
                      Key="SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\gcc.exe"
                      Type="raw" />
    </Property>

    <Property Id="GCC_APP_PATH_WOW">
      <RegistrySearch Id="GccAppPathsWow"
                      Root="HKLM"
                      Key="SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\App Paths\gcc.exe"
                      Type="raw" />
    </Property>

    <!-- GCC: rutas típicas (MSYS2 / MinGW) -->
    <Property Id="GCC_IN_MSYS2_MINGW64">
      <DirectorySearch Id="GccMsys2Mingw64Dir" Path="C:\msys64\mingw64\bin">
        <FileSearch Id="GccMsys2Mingw64Exe" Name="gcc.exe" />
      </DirectorySearch>
    </Property>

    <Property Id="GCC_IN_MSYS2_USR">
      <DirectorySearch Id="GccMsys2UsrDir" Path="C:\msys64\usr\bin">
        <FileSearch Id="GccMsys2UsrExe" Name="gcc.exe" />
      </DirectorySearch>
    </Property>

    <Property Id="GCC_IN_MINGW">
      <DirectorySearch Id="GccMingwDir" Path="C:\MinGW\bin">
        <FileSearch Id="GccMingwExe" Name="gcc.exe" />
      </DirectorySearch>
    </Property>

    <!-- Launch conditions (WiX v4): usar Launch -->
    <Launch
      Condition="NASM_APP_PATH OR NASM_APP_PATH_WOW OR NASM_IN_PROGFILES64 OR NASM_IN_PROGFILES32"
      Message="No se encontró NASM (nasm.exe). Instálalo y vuelve a ejecutar el instalador." />

    <Launch
      Condition="GCC_APP_PATH OR GCC_APP_PATH_WOW OR GCC_IN_MSYS2_MINGW64 OR GCC_IN_MSYS2_USR OR GCC_IN_MINGW"
      Message="No se encontró GCC (gcc.exe). Instálalo (por ejemplo MSYS2/MinGW) y vuelve a ejecutar el instalador." />

    <Feature Id="CoreFeature" Title="Core" Level="1">
      <ComponentGroupRef Id="CoreRootFiles" />
      <ComponentGroupRef Id="CoreBinFiles" />
      <ComponentGroupRef Id="CoreShareFiles" />
      <ComponentRef Id="PathEnv" />
    </Feature>

    <Feature Id="LLVMFeature" Title="LLVM Backend" Level="2">
      <?if $(var.HasLlvmBackend) = 1 ?>
        <ComponentGroupRef Id="LlvmBackendFiles" />
      <?endif?>
    </Feature>

  </Package>

  <Fragment>
    <WixVariable Id="WixUIInstallDir" Value="INSTALLDIR" />
  </Fragment>

  <Fragment>
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLDIR" Name="AymaraLang">
        <Directory Id="BINDIR" Name="bin" />
        <Directory Id="SHAREDIR" Name="share" />
        <Directory Id="LLVMBACKENDDIR" Name="llvm-backend" />
      </Directory>
    </StandardDirectory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="CoreRootFiles" Directory="INSTALLDIR" Source="$(var.DistDir)">
      <Files Include="README.md" />
      <Files Include="LICENSE" />
    </ComponentGroup>

    <ComponentGroup Id="CoreBinFiles" Directory="BINDIR" Source="$(var.DistDir)\bin">
      <Files Include="**\*" />
    </ComponentGroup>

    <ComponentGroup Id="CoreShareFiles" Directory="SHAREDIR" Source="$(var.DistDir)\share">
      <Files Include="**\*" />
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <Component Id="PathEnv" Directory="INSTALLDIR" Guid="D3D1F4E4-9E39-4E0B-A6C1-0E5D8A6A3C11">
      <RegistryValue Root="HKLM"
                     Key="Software\AymaraLang"
                     Name="Installed"
                     Type="integer"
                     Value="1"
                     KeyPath="yes" />

      <Environment Id="AymaraLangPath"
                   Name="PATH"
                   Value="[BINDIR]"
                   Part="last"
                   System="yes"
                   Action="set" />
    </Component>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="LlvmBackendFiles" Directory="LLVMBACKENDDIR" Source="$(var.LlvmDir)">
      <?if $(var.HasLlvmBackend) = 1 ?>
        <Files Include="**\*" />
      <?endif?>
    </ComponentGroup>
  </Fragment>

</Wix>
